.PHONY: all clean distclean install pkg-config

ifdef ENABLE_DEBUG
override _CPPFLAGS=-UNDEBUG
override _CFLAGS+=-g -O0 -Wall -std=c99
else
override _CPPFLAGS=-DNDEBUG
override _CFLAGS+=-O2 -std=c99
endif

ABIVERSION=1
RELEASEVERSION=0
_SONAME=libhashit.so.$(ABIVERSION)

HASHIT_OBJECTS=$(patsubst %.c,%.o,$(wildcard src/*.c))
DEPENDENCIES=$(patsubst %.o,%.d,$(HASHIT_OBJECTS))
POFILES=$(wildcard po/*.po)

all: src/libhashit.so.$(ABIVERSION).$(RELEASEVERSION) libhashit.pc 

src/libhashit.so.$(ABIVERSION).$(RELEASEVERSION): $(HASHIT_OBJECTS)
	$(MAKE.shared) $@ $^

libhashit.pc: libhashit.pc.in
	@$(call munge_file,libhashit.pc.in,libhashit.pc)

clean:
	@rm -rf $(HASHIT_OBJECTS) $(DEPENDENCIES) src/libhashit.so.*

distclean: clean
	@rm -rf Makefile config.mk config.h 

DIRMODE="a+rx,u+w"

install: all
	@$(call makedir,$(LIBDIR),$(DIRMODE))
	@$(call install_files,src/libhashit.so.1.0,$(LIBDIR),a=rx)
	@$(call makedir,$(INCDIR),$(DIRMODE))
	@$(call install_files,src/hashit.h,$(INCDIR),a=rx)
	@$(call makedir,$(LIBDIR)/pkgconfig,$(DIRMODE))
	@$(call install_files,libhashit.pc,$(LIBDIR)/pkgconfig,a=rx)
	@ln -s $(LIBDIR)/libhashit.so.$(ABIVERSION).$(RELEASEVERSION) $(LIBDIR)/libhashit.so 2> /dev/null; true
	@ldconfig
	
